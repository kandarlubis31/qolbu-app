---
import BaseLayout from '../layouts/BaseLayout.astro';
---

<BaseLayout pageTitle="Tasbih Digital">
  
  <div class="sticky top-0 z-40 bg-white/80 dark:bg-slate-900/80 backdrop-blur-md p-4 flex items-center justify-between border-b border-slate-100 dark:border-slate-800">
    <a href="/" class="flex items-center gap-2 text-slate-500 hover:text-emerald-600 transition-colors">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
      <span class="font-medium text-sm">Dashboard</span>
    </a>
    <div class="flex gap-2">
      <select id="target-select" class="bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 text-xs rounded-lg px-2 py-1 outline-none border-none cursor-pointer">
        <option value="33">Target: 33</option>
        <option value="99">Target: 99</option>
        <option value="100">Target: 100</option>
        <option value="0">Tanpa Batas</option>
      </select>
      <button id="reset-btn" class="p-2 bg-rose-100 dark:bg-rose-900/30 text-rose-600 rounded-lg hover:bg-rose-200 transition-colors" title="Reset Hitungan">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
      </button>
    </div>
  </div>

  <div class="min-h-[80vh] flex flex-col items-center justify-center py-6 px-4">
    
    <!-- Dhikr Selection -->
    <div class="mb-6 w-full max-w-md">
      <div class="flex flex-wrap justify-center gap-2 mb-4">
        <button class="dhikr-btn px-4 py-2 rounded-full bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-300 text-sm font-medium transition-colors" data-dhikr="Subhanallah">Subhanallah</button>
        <button class="dhikr-btn px-4 py-2 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 text-sm font-medium transition-colors" data-dhikr="Alhamdulillah">Alhamdulillah</button>
        <button class="dhikr-btn px-4 py-2 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 text-sm font-medium transition-colors" data-dhikr="Allahu Akbar">Allahu Akbar</button>
        <button class="dhikr-btn px-4 py-2 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 text-sm font-medium transition-colors" data-dhikr="Laa ilaaha illallah">Laa ilaaha illallah</button>
      </div>
      <div class="text-center">
        <p id="current-dhikr" class="text-lg font-medium text-slate-700 dark:text-slate-300">Subhanallah</p>
      </div>
    </div>
    
    <!-- Progress Bar -->
    <div class="w-full max-w-md mb-6">
      <div class="bg-slate-200 dark:bg-slate-700 rounded-full h-2 overflow-hidden">
        <div id="progress-bar" class="bg-emerald-500 h-full transition-all duration-300" style="width: 0%"></div>
      </div>
      <div class="flex justify-between mt-1">
        <span id="progress-text" class="text-xs text-slate-500 dark:text-slate-400">0 / 33</span>
        <span id="percentage-text" class="text-xs text-slate-500 dark:text-slate-400">0%</span>
      </div>
    </div>
    
    <button 
      id="counter-btn"
      class="group relative w-72 h-72 rounded-full flex items-center justify-center transition-all duration-100 active:scale-95 touch-manipulation select-none"
    >
      <div class="absolute inset-0 bg-emerald-500 rounded-full opacity-10 group-hover:opacity-20 animate-pulse"></div>
      <div class="absolute inset-4 bg-white dark:bg-slate-800 rounded-full shadow-2xl border-8 border-emerald-50 dark:border-slate-700 flex flex-col items-center justify-center">
        
        <span class="text-xs text-slate-400 uppercase tracking-widest font-bold mb-2">Hitungan</span>
        
        <h1 id="count-display" class="text-8xl font-black text-slate-800 dark:text-white tabular-nums tracking-tighter">
          0
        </h1>
        
        <p id="target-display" class="text-xs text-emerald-500 mt-2 font-medium opacity-0 transition-opacity">
          Target Tercapai! ðŸŽ‰
        </p>
      </div>
      
      <span class="absolute inset-0 rounded-full overflow-hidden pointer-events-none"></span>
    </button>

    <div class="mt-12 text-center space-y-2">
      <p class="text-slate-500 dark:text-slate-400 text-sm">
        Klik lingkaran atau tekan <kbd class="px-2 py-1 bg-slate-100 dark:bg-slate-800 rounded-md border border-slate-200 dark:border-slate-700 font-mono text-xs">Spasi</kbd>
      </p>
      
      <div class="flex justify-center gap-4 mt-4">
        <button id="toggle-vibrate" class="flex items-center gap-2 px-4 py-2 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 text-xs font-medium transition-colors opacity-100">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
          Getar: ON
        </button>
        <button id="toggle-sound" class="flex items-center gap-2 px-4 py-2 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 text-xs font-medium transition-colors opacity-100">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
          Suara: ON
        </button>
      </div>
      
      <!-- Statistics -->
      <div class="mt-6 p-4 bg-slate-100 dark:bg-slate-800 rounded-lg w-full max-w-md">
        <h3 class="text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Statistik Hari Ini</h3>
        <div class="grid grid-cols-3 gap-2 text-center">
          <div>
            <p id="today-total" class="text-2xl font-bold text-emerald-600 dark:text-emerald-400">0</p>
            <p class="text-xs text-slate-500 dark:text-slate-400">Total</p>
          </div>
          <div>
            <p id="today-sessions" class="text-2xl font-bold text-blue-600 dark:text-blue-400">0</p>
            <p class="text-xs text-slate-500 dark:text-slate-400">Sesi</p>
          </div>
          <div>
            <p id="today-streak" class="text-2xl font-bold text-purple-600 dark:text-purple-400">0</p>
            <p class="text-xs text-slate-500 dark:text-slate-400">Streak</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Success Modal -->
  <div id="success-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
    <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 max-w-sm mx-4 transform transition-all scale-95 opacity-0">
      <div class="text-center">
        <div class="w-16 h-16 bg-emerald-100 dark:bg-emerald-900/30 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-emerald-600 dark:text-emerald-400"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
        </div>
        <h3 class="text-xl font-bold text-slate-800 dark:text-white mb-2">Target Tercapai!</h3>
        <p class="text-slate-600 dark:text-slate-300 mb-4">Anda telah menyelesaikan <span id="completed-dhikr">Subhanallah</span> sebanyak <span id="completed-count">33</span> kali.</p>
        <div class="flex gap-2 justify-center">
          <button id="continue-btn" class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-colors">Lanjut</button>
          <button id="reset-modal-btn" class="px-4 py-2 bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300 rounded-lg hover:bg-slate-300 dark:hover:bg-slate-600 transition-colors">Reset</button>
        </div>
      </div>
    </div>
  </div>

</BaseLayout>

<script is:inline>
  // DOM Elements
  const countDisplay = document.getElementById('count-display');
  const counterBtn = document.getElementById('counter-btn');
  const resetBtn = document.getElementById('reset-btn');
  const targetSelect = document.getElementById('target-select');
  const targetDisplay = document.getElementById('target-display');
  const toggleVibrate = document.getElementById('toggle-vibrate');
  const toggleSound = document.getElementById('toggle-sound');
  const progressBar = document.getElementById('progress-bar');
  const progressText = document.getElementById('progress-text');
  const percentageText = document.getElementById('percentage-text');
  const successModal = document.getElementById('success-modal');
  const modalContent = successModal.querySelector('div');
  const continueBtn = document.getElementById('continue-btn');
  const resetModalBtn = document.getElementById('reset-modal-btn');
  const completedDhikr = document.getElementById('completed-dhikr');
  const completedCount = document.getElementById('completed-count');
  const currentDhikrDisplay = document.getElementById('current-dhikr');
  const dhikrBtns = document.querySelectorAll('.dhikr-btn');
  
  // Statistics Elements
  const todayTotal = document.getElementById('today-total');
  const todaySessions = document.getElementById('today-sessions');
  const todayStreak = document.getElementById('today-streak');

  // State
  let count = parseInt(localStorage.getItem('tasbih-count') || '0');
  let target = parseInt(localStorage.getItem('tasbih-target') || '33');
  let vibrateEnabled = localStorage.getItem('tasbih-vibrate') !== 'false'; // Default ON
  let soundEnabled = localStorage.getItem('tasbih-sound') !== 'false'; // Default ON
  let currentDhikr = localStorage.getItem('tasbih-dhikr') || 'Subhanallah';
  
  // Statistics State
  let todayDate = new Date().toDateString();
  let stats = JSON.parse(localStorage.getItem('tasbih-stats') || '{}');
  
  // Initialize today's stats if not exists
  if (!stats[todayDate]) {
    stats[todayDate] = {
      total: 0,
      sessions: 0,
      completed: false
    };
  }

  // Audio context for sound effects
  let audioContext;
  
  // Init UI
  countDisplay.innerText = count;
  targetSelect.value = target;
  currentDhikrDisplay.innerText = currentDhikr;
  updateVibrateUI();
  updateSoundUI();
  updateProgressBar();
  updateStatistics();
  updateDhikrButtons();

  // --- Logic Functions ---

  function updateDhikrButtons() {
    dhikrBtns.forEach(btn => {
      if (btn.dataset.dhikr === currentDhikr) {
        btn.classList.remove('bg-slate-100', 'dark:bg-slate-800', 'text-slate-600', 'dark:text-slate-300');
        btn.classList.add('bg-emerald-100', 'dark:bg-emerald-900/30', 'text-emerald-700', 'dark:text-emerald-300');
      } else {
        btn.classList.remove('bg-emerald-100', 'dark:bg-emerald-900/30', 'text-emerald-700', 'dark:text-emerald-300');
        btn.classList.add('bg-slate-100', 'dark:bg-slate-800', 'text-slate-600', 'dark:text-slate-300');
      }
    });
  }

  function updateVibrateUI() {
    if (vibrateEnabled) {
      toggleVibrate.classList.remove('opacity-50');
      toggleVibrate.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg> Getar: ON`;
    } else {
      toggleVibrate.classList.add('opacity-50');
      toggleVibrate.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg> Getar: OFF`;
    }
  }

  function updateSoundUI() {
    if (soundEnabled) {
      toggleSound.classList.remove('opacity-50');
      toggleSound.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg> Suara: ON`;
    } else {
      toggleSound.classList.add('opacity-50');
      toggleSound.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><line x1="23" y1="9" x2="17" y2="15"></line><line x1="17" y1="9" x2="23" y2="15"></line></svg> Suara: OFF`;
    }
  }

  function updateProgressBar() {
    if (target > 0) {
      const percentage = Math.min((count / target) * 100, 100);
      progressBar.style.width = `${percentage}%`;
      progressText.textContent = `${count} / ${target}`;
      percentageText.textContent = `${Math.round(percentage)}%`;
    } else {
      progressBar.style.width = '0%';
      progressText.textContent = `${count} / âˆž`;
      percentageText.textContent = '0%';
    }
  }

  function updateStatistics() {
    // Update today's stats
    todayTotal.textContent = stats[todayDate].total;
    todaySessions.textContent = stats[todayDate].sessions;
    
    // Calculate streak
    let streak = 0;
    let currentDate = new Date();
    currentDate.setDate(currentDate.getDate() - 1); // Start from yesterday
    
    while (true) {
      const dateStr = currentDate.toDateString();
      if (stats[dateStr] && stats[dateStr].completed) {
        streak++;
        currentDate.setDate(currentDate.getDate() - 1);
      } else {
        break;
      }
    }
    
    // If today is completed, add to streak
    if (stats[todayDate].completed) {
      streak++;
    }
    
    todayStreak.textContent = streak;
  }

  function playSound(frequency = 800, duration = 100) {
    if (!soundEnabled) return;
    
    // Initialize audio context on first user interaction
    if (!audioContext) {
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
    }
    
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    oscillator.frequency.value = frequency;
    oscillator.type = 'sine';
    
    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration / 1000);
    
    oscillator.start(audioContext.currentTime);
    oscillator.stop(audioContext.currentTime + duration / 1000);
  }

  function triggerFeedback() {
    // Efek Getar (Haptic) - Cuma jalan di HP Android
    if (vibrateEnabled && navigator.vibrate) {
      navigator.vibrate(15); // Getar pendek 15ms
    }
    
    // Play sound
    playSound(800, 100);
    
    // Animasi Scale
    countDisplay.classList.add('scale-110', 'text-emerald-600', 'dark:text-emerald-400');
    setTimeout(() => {
      countDisplay.classList.remove('scale-110', 'text-emerald-600', 'dark:text-emerald-400');
    }, 100);
    
    // Update progress bar
    updateProgressBar();
  }

  function checkTarget() {
    if (target > 0 && count % target === 0 && count !== 0) {
      // Getar panjang dikit kalau target tercapai
      if (vibrateEnabled && navigator.vibrate) navigator.vibrate([50, 50, 50]);
      
      // Play success sound
      playSound(1200, 200);
      
      // Update statistics
      stats[todayDate].total += target;
      stats[todayDate].sessions += 1;
      stats[todayDate].completed = true;
      localStorage.setItem('tasbih-stats', JSON.stringify(stats));
      updateStatistics();
      
      // Show success modal
      completedDhikr.textContent = currentDhikr;
      completedCount.textContent = target;
      successModal.classList.remove('hidden');
      setTimeout(() => {
        modalContent.classList.remove('scale-95', 'opacity-0');
        modalContent.classList.add('scale-100', 'opacity-100');
      }, 10);
      
      // Also show the old notification for backward compatibility
      targetDisplay.classList.remove('opacity-0');
      targetDisplay.classList.add('animate-bounce');
      setTimeout(() => {
        targetDisplay.classList.add('opacity-0');
        targetDisplay.classList.remove('animate-bounce');
      }, 2000);
    }
  }

  function increment() {
    count++;
    countDisplay.innerText = count;
    localStorage.setItem('tasbih-count', count);
    triggerFeedback();
    checkTarget();
  }

  function reset() {
    if(confirm('Reset hitungan ke 0?')) {
      count = 0;
      countDisplay.innerText = count;
      localStorage.setItem('tasbih-count', count);
      updateProgressBar();
      if (vibrateEnabled && navigator.vibrate) navigator.vibrate(50);
    }
  }

  function closeModal() {
    modalContent.classList.remove('scale-100', 'opacity-100');
    modalContent.classList.add('scale-95', 'opacity-0');
    setTimeout(() => {
      successModal.classList.add('hidden');
    }, 300);
  }

  // --- Event Listeners ---

  counterBtn.addEventListener('mousedown', (e) => {
    // Mencegah double tap zoom di beberapa browser
    if (e.detail > 1) e.preventDefault();
  });

  counterBtn.addEventListener('click', increment);

  // Support Keyboard (Spasi / Enter)
  document.addEventListener('keydown', (e) => {
    if (e.code === 'Space' || e.code === 'Enter') {
      e.preventDefault(); // Biar gak scroll halaman
      increment();
    }
  });

  resetBtn.addEventListener('click', reset);

  targetSelect.addEventListener('change', (e) => {
    target = parseInt(e.target.value);
    localStorage.setItem('tasbih-target', target);
    updateProgressBar();
  });

  toggleVibrate.addEventListener('click', () => {
    vibrateEnabled = !vibrateEnabled;
    localStorage.setItem('tasbih-vibrate', vibrateEnabled);
    updateVibrateUI();
    if(vibrateEnabled && navigator.vibrate) navigator.vibrate(30);
  });

  toggleSound.addEventListener('click', () => {
    soundEnabled = !soundEnabled;
    localStorage.setItem('tasbih-sound', soundEnabled);
    updateSoundUI();
    if(soundEnabled) playSound(1000, 100);
  });

  // Dhikr selection
  dhikrBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      currentDhikr = btn.dataset.dhikr;
      currentDhikrDisplay.innerText = currentDhikr;
      localStorage.setItem('tasbih-dhikr', currentDhikr);
      updateDhikrButtons();
      if (vibrateEnabled && navigator.vibrate) navigator.vibrate(20);
    });
  });

  // Modal buttons
  continueBtn.addEventListener('click', () => {
    closeModal();
    // Continue counting without resetting
  });

  resetModalBtn.addEventListener('click', () => {
    closeModal();
    reset();
  });

  // Check if date changed and update stats
  setInterval(() => {
    const newDate = new Date().toDateString();
    if (newDate !== todayDate) {
      todayDate = newDate;
      if (!stats[todayDate]) {
        stats[todayDate] = {
          total: 0,
          sessions: 0,
          completed: false
        };
      }
      updateStatistics();
    }
  }, 60000); // Check every minute
</script>